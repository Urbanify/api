// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum UserRole {
  RESIDENT
  MANAGER
  OWNER
  ADMIN
  FINANCIAL

  @@map("user_role")
}

model User {
  id        String   @id @default(uuid()) @db.Uuid
  name      String
  surname   String
  email     String   @unique
  password  String
  cpf       String   @unique
  cityId    String?
  role      UserRole @default(RESIDENT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  issuesReported Issue[]        @relation("reporter")
  issuesFiscal   Issue[]        @relation("fiscal")
  issuesManaged  Issue[]        @relation("manager")
  issueHistory   IssueHistory[]
  comments       Comment[]

  @@map("users")
}

model FeatureFlag {
  id          String   @id @default(uuid()) @db.Uuid
  slug        String
  description String
  deleted     Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  cityFeatures CityFeature[]

  @@index([deleted])
  @@map("feature_flags")
}

enum CityStatus {
  ACTIVE
  OVERDUE
  DISABLED
  DELETED

  @@map("city_status")
}

model City {
  id        String     @id @default(uuid()) @db.Uuid
  name      String
  latitude  String
  longitude String
  status    CityStatus @default(ACTIVE)
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  cityFeatures CityFeature[]

  @@map("cities")
}

model CityFeature {
  id            String   @id @default(uuid()) @db.Uuid
  cityId        String   @db.Uuid
  featureFlagId String   @db.Uuid
  status        Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  city        City        @relation(fields: [cityId], references: [id], onDelete: Cascade)
  featureFlag FeatureFlag @relation(fields: [featureFlagId], references: [id], onDelete: Cascade)

  @@unique([cityId, featureFlagId])
  @@map("city_features")
}

enum IssueStatus {
  WAITING_FOR_FISCAL
  WAITING_FOR_PROCEDURE
  WAITING_FOR_MANAGER
  WAITING_FOR_MANAGER_RESOLUTION
  WAITING_FOR_RESOLUTION_VALIDATION
  SOLVED
  CLOSED

  @@map("issue_status")
}

enum IssueCategory {
  INFRASTRUCTURE
  ENVIRONMENT
  TRANSPORTATION
  SAFETY
  COMUNITY

  @@map("issue_category")
}

enum IssueType {
  // INFRASTRUCTURE
  ROAD_POTHOLE
  DAMAGED_SIGNAGE
  DAMAGED_SIDEWALK
  STREETLIGHT_OUT

  // ENVIRONMENT
  FALLEN_WIRES
  WALL_RISK_OF_COLLAPSE
  EROSION
  ABANDONED_CONSTRUCTION
  FALLEN_TREE
  TREE_COLLAPSE_RISK
  ILLEGAL_DEFORESTATION
  GARBAGE_ACCUMULATION
  ILLEGAL_WASTE_DISPOSAL
  SEWAGE_LEAK
  LACK_OF_SANITATION
  DEAD_ANIMALS
  FLOODING

  // TRANSPORTATION
  DAMAGED_BUS_STOP
  OBSTRUCTED_BIKE_LANE
  ILLEGAL_PARKING
  ABANDONED_VEHICLE
  FADED_PEDESTRIAN_CROSSWALK

  // SAFETY
  DARK_AREA
  VANDALISM
  GRAFFITI
  STRUCTURAL_RISK

  // COMUNITY
  ILLEGAL_OCCUPATION
  ILLEGAL_CONSTRUCTION

  @@map("issue_type")
}

model Issue {
  id          String        @id @default(uuid()) @db.Uuid
  status      IssueStatus   @default(WAITING_FOR_FISCAL)
  cityId      String
  latitude    String
  longitude   String
  category    IssueCategory
  type        IssueType
  description String
  reporterId  String?       @db.Uuid
  fiscalId    String?       @db.Uuid
  managerId   String?       @db.Uuid
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  reporter User?          @relation("reporter", fields: [reporterId], references: [id], onDelete: SetNull)
  fiscal   User?          @relation("fiscal", fields: [fiscalId], references: [id], onDelete: SetNull)
  manager  User?          @relation("manager", fields: [managerId], references: [id], onDelete: SetNull)
  history  IssueHistory[]
  photos   IssuePhoto[]
  comments Comment[]

  @@index([cityId])
  @@map("issues")
}

enum IssueHistoryAction {
  REPORTED_ISSUE
  ASSIGNED_AS_FISCAL
  ASSIGNED_AS_MANAGER
  MARKED_AS_UNFOUNDED
  MARKED_AS_VALID
  ADDED_RESOLUTION
  MARKED_AS_SOLVED
  REQUESTED_NEW_SOLUTION
}

model IssueHistory {
  id          String             @id @default(uuid()) @db.Uuid
  issueId     String             @db.Uuid
  userId      String?            @db.Uuid
  userName    String
  action      IssueHistoryAction
  description String?
  createdAt   DateTime           @default(now())
  updatedAt   DateTime           @updatedAt

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)
  user  User? @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@map("issue_history")
}

model IssuePhoto {
  id        String   @id @default(uuid()) @db.Uuid
  issueId   String   @db.Uuid
  url       String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  issue Issue @relation(fields: [issueId], references: [id], onDelete: Cascade)

  @@map("issue_photos")
}

model Comment {
  id        String   @id @default(uuid()) @db.Uuid
  text      String
  issueId   String   @db.Uuid
  cityId    String   @db.Uuid
  authorId  String   @db.Uuid
  parentId  String?  @db.Uuid
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  issue    Issue     @relation(fields: [issueId], references: [id], onDelete: Cascade)
  author   User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent   Comment?  @relation("parent", fields: [parentId], references: [id], onDelete: Cascade)
  children Comment[] @relation("parent")

  @@index([cityId])
  @@index([authorId])
  @@map("comments")
}
